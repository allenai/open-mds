# Usage

This directory contains the SLURM submission scripts that were used to organize the experiments. Even if you aren't using SLURM, they are helpful to reproduce our results or understand our experiments.

## Perturbation Experiments

The perturbation experiments are reproduced with the `perturb.sh` and `submit_perturb.sh` scripts.

### `perturb.sh`

This script is used to run a single perturbation experiment, e.g.

```bash
sbatch "./scripts/slurm/perturb.sh" "./conf/multinews/primera/eval.yml" \
  "./output/results/multinews/primera/peturbations/random/addition/0.1" \
  "addition" \
  "random" \
  "0.1"
```

would submit the `"addition"` perturbation experiment with the `"random"` strategy, perturbing 10% of the input documents, and save the results to `"./output/results/multinews/primera/peturbations/random/addition/0.1"`.

### `submit_perturb.sh`

This script is used to submit _all_ perturbation experiments for a given model, dataset pair, including the baseline evaluation (no perturbations), e.g.

```bash
bash "./scripts/slurm/submit_perturb.sh" \
  "./conf/multinews/primera/eval.yml" \
  "./output/results/multinews/primera"
```

would submit all perturbation experiments for the [PRIMERA](https://arxiv.org/abs/2110.08499) model on the [Multi-News](https://aclanthology.org/P19-1102/) dataset (including the baseline evaluation) and save the results to `"./output/results/multinews/primera/peturbations"`.

## Indexing (OPTIONAL)

This is only required if you want to re-index the datasets. We have already done this and made them publicly available. Just look for `"allenai/[dataset_name]_[sparse|dense]_[max|mean|oracle]"` on [HuggingFace](https://huggingface.co/datasets), e.g. [`"allenai/multinews_sparse_mean"`](https://huggingface.co/datasets/allenai/multinews_sparse_mean).

### `index.sh`

TODO

### `submit_index.sh`

TODO

## Retrieval (or "Open-domain MDS") Experiments

The retrieval experiments (also called the "Open-domain MDS" experiments in the paper) are reproduced with the `retrieval.sh` and `submit_retrieval.sh` scripts.

### `retrieve.sh`

This script is used to run a single retrieval experiment, e.g.

```bash
sbatch "./scripts/slurm/retrieve.sh" "./conf/multinews/primera/eval.yml" \
  "./output/results/multinews/primera/retrieval/sparse/mean" \
  "allenai/multinews_sparse_mean" \
  "sparse" \
  "mean"
```

would submit a job evaluating the [PRIMERA](https://arxiv.org/abs/2110.08499) model on the [Multi-News](https://aclanthology.org/P19-1102/) dataset, whose documents have been retrieved using the `"sparse"` retriever with the `"mean"` top-k strategy, and save the results to `"./output/results/multinews/primera/retrieval/sparse/mean"`.

### `submit_retrieve.sh`

This script is used to submit _all_ retrieval experiments for a given model, dataset pair, e.g.

```bash
bash "./scripts/slurm/submit_retrieve.sh" "./conf/multinews/primera/eval.yml" \
  "./output/results/multinews/primera" \
  "./output/datasets/multinews"
```

would submit all retrieval experiments for the [PRIMERA](https://arxiv.org/abs/2110.08499) model on the [Multi-News](https://aclanthology.org/P19-1102/) dataset and save the results to `"./output/results/multinews/primera/retrieval"`.

## Extended Training Experiments

The extended training experiments are reproduced with the `retrieve.sh` and `submit_eval_checkpoints` scripts.

### `retrieve.sh`

This script is used to extend the training of the model on the retrieved documents. It is used in a similar way as in the retrieval experiments, except we provide a different configuration file (`"train_retrieved.yml"`), e.g.

```bash
sbatch "./scripts/slurm/retrieve.sh" "./conf/multinews/primera/train_retrieved.yml" \
  "./output/results/multinews/primera/trained_with_retrieval" \
  "allenai/multinews_dense_mean" \
  "dense" \
  "mean"
```

would submit a job to train the [PRIMERA](https://arxiv.org/abs/2110.08499) model on the [Multi-News](https://aclanthology.org/P19-1102/) dataset, whose documents have been retrieved using the `"dense"` retirever with the `"mean"` top-k strategy, and save the results to `"./output/results/multinews/primera/trained_with_retrieval"`.

### `submit_eval_checkpoints.sh`

This script will evaluate all the checkpoints from a single training run generated by `retrieve.sh` in the previous step.

```bash
bash "./scripts/slurm/submit_eval_checkpoints.sh" \
  "./conf/multinews/primera/eval.yml" \
  "./output/multinews/primera/trained_with_retrieval" \
  "./output/multinews/primera" \
  "allenai/multinews_dense_mean" \
  "dense" \
  "mean"
```

would submit jobs to evaluate each of the trained checkpoints in `"./output/multinews/primera/trained_with_retrieval"` and save the results to `"./output/results/multinews/primera/training"`.